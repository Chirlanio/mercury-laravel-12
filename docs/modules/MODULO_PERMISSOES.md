# Análise do Módulo de Permissões

**Dependência:** Este módulo é uma dependência direta do módulo de **Níveis de Acesso**.

## 1. Visão Geral

O módulo de Permissões é responsável por controlar o que cada Nível de Acesso pode ver e fazer no sistema. Ele permite ao administrador conceder ou revogar o acesso a páginas específicas, controlar a visibilidade de itens de menu e definir se uma página aparecerá em um submenu (dropdown).

## 2. Arquitetura e Fluxo de Dados

O módulo segue o mesmo padrão arquitetural do restante do sistema, com uma estrutura MVC customizada.

### Componentes Principais:

*   **Controller Principal**: `Permissoes.php` é o ponto de entrada que lista as permissões para um determinado nível de acesso.
*   **Controllers de Ação**: Uma série de pequenos controllers (`LibPermi.php`, `LibMenu.php`, `LibDropdown.php`, `AltOrdemMenu.php`, `EditarNivAcPgMenu.php`) que são chamados para executar ações específicas.
*   **Models**: Cada controller possui um model correspondente que contém a lógica de negócio e o acesso ao banco de dados.
*   **View**: A view principal (`listarPermi.php`) exibe a lista de permissões e os botões de ação.

### Fluxo Típico (Ex: Liberar Permissão):

1.  O administrador está na página de listagem de permissões para um Nível de Acesso específico.
2.  Ele clica no botão para liberar ou bloquear o acesso a uma página.
3.  Esta ação aciona uma requisição GET para um controller específico, como `LibPermi.php`.
4.  O controller `LibPermi` recebe o ID da permissão (da tabela `adms_nivacs_pgs`).
5.  Ele instancia o model `AdmsLibPermi` e chama o método `libPermi()`.
6.  O model `AdmsLibPermi` lê o estado atual da permissão no banco de dados e inverte seu valor (de 1 para 2, ou de 2 para 1).
7.  Após a atualização, o controller redireciona o usuário de volta para a página de listagem de permissões.

## 3. Arquivos do Módulo

| Tipo        | Arquivo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - |
| Controller  | `Permissoes.php`, `LibPermi.php`, `LibMenu.php`, `LibDropdown.php`, `AltOrdemMenu.php`, `EditarNivAcPgMenu.php`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - |
| Model       | `AdmsListarPermi.php`, `AdmsLibPermi.php`, `AdmsLibMenu.php`, `AdmsLibDropdown.php`, `AdmsAltOrdemMenu.php`, `AdmsEditarNivAcPgMenu.php`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - |
| View        | `listarPermi.php`, `editarNivAcPgMenu.php`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - |

## 4. Base de Dados

A tabela principal para este módulo é a `adms_nivacs_pgs`. Ela serve como uma tabela pivot que liga os níveis de acesso (`adms_niveis_acessos`) às páginas (`adms_paginas`).

*   `id`: Chave primária.
*   `adms_niveis_acesso_id`: Chave estrangeira para `adms_niveis_acessos`.
*   `adms_pagina_id`: Chave estrangeira para `adms_paginas`.
*   `permissao`: (1 para Permitido, 2 para Bloqueado) - Controla o acesso à página.
*   `ordem`: Controla a ordem em que as páginas aparecem no menu.
*   `lib_menu`: (1 para Visível, 2 para Oculto) - Controla se a página aparece no menu.
*   `dropdown`: (1 para Sim, 2 para Não) - Controla se a página é um item de um submenu.

## 5. Análise Crítica e Pontos de Melhoria

### 5.1. Vulnerabilidade de Segurança (Crítica)

O model `AdmsListarPermi` possui uma **vulnerabilidade de SQL Injection** na query de listagem. A variável `$_SESSION['adms_niveis_acesso_id']` é injetada diretamente na string SQL.

**Trecho Vulnerável:**
```sql
... AND (((SELECT permissao FROM adms_nivacs_pgs WHERE adms_pagina_id=nivpg.adms_pagina_id AND adms_niveis_acesso_id={$_SESSION['adms_niveis_acesso_id']}) = 1) OR ...
```

*   **Risco**: Um usuário mal-intencionado poderia manipular o valor da sessão para injetar código SQL malicioso, potencialmente lendo, modificando ou apagando dados do banco de dados.
*   **Correção Urgente**: A variável de sessão deve ser substituída por um parâmetro nomeado (placeholder) e passada através do método de binding do PDO, assim como os outros parâmetros da query.

### 5.2. Complexidade da Query

A mesma query de listagem em `AdmsListarPermi` é excessivamente complexa devido à subquery correlacionada. Esta subquery verifica a permissão do usuário logado para cada linha da permissão que está sendo listada, o que pode causar lentidão em sistemas com muitas páginas ou níveis de acesso.

*   **Sugestão**: A lógica de verificação de permissão do usuário logado deveria ser separada. Uma abordagem mais eficiente seria:
    1.  Primeiro, buscar a lista de páginas que o usuário logado tem permissão para ver.
    2.  Depois, na query principal, usar um `JOIN` ou um `WHERE IN` com a lista de IDs de páginas permitidas.

### 5.3. Requisições GET para Alteração de Estado

As ações de "liberar/bloquear" permissão, menu e dropdown são feitas através de requisições `GET`. Isso viola o princípio do HTTP, que diz que requisições `GET` devem ser seguras e idempotentes (não devem alterar o estado do servidor).

*   **Risco**: Facilita ataques de CSRF (Cross-Site Request Forgery) e pode ser acionado acidentalmente por crawlers de busca.
*   **Sugestão**: Essas ações devem ser alteradas para usar requisições `POST` ou `PUT`/`PATCH`, idealmente via AJAX, e protegidas com tokens anti-CSRF.

### 5.4. Experiência do Usuário (UX)

Cada ação de alteração de permissão causa um recarregamento completo da página. Isso torna a tarefa de configurar as permissões de um nível de acesso tediosa e lenta.

*   **Sugestão**: Implementar as ações de alteração de permissão com **AJAX**. Ao clicar em um botão, uma requisição assíncrona seria enviada ao backend. O backend responderia com JSON (`{ "success": true }`) e o frontend apenas atualizaria o ícone (de bloqueado para permitido, por exemplo) dinamicamente, sem recarregar a página.

### 5.5. Consolidação de Código

Existem múltiplos controllers e models pequenos que fazem coisas muito parecidas (`LibPermi`, `LibMenu`, `LibDropdown`).

*   **Sugestão**: Refatorar e consolidar estes controllers e models em um único `PermissionManagerController` e um `PermissionManagerService`. Este serviço teria métodos como `togglePermission(int $permissionId, string $field)`, onde `$field` poderia ser `'permissao'`, `'lib_menu'`, etc. Isso reduziria a duplicação de código e centralizaria a lógica.

## 6. Conclusão

O módulo de permissões é funcional, mas apresenta sérios riscos de segurança e oportunidades de melhoria em performance, usabilidade e manutenibilidade. A correção da vulnerabilidade de SQL Injection é **prioridade máxima**. As demais sugestões, se implementadas, modernizariam o módulo, tornando-o mais seguro, rápido e agradável de usar, além de alinhar o código com as melhores práticas de desenvolvimento web moderno.
